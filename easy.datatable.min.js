// jQuery EasyDataTable Plugin
//
// Version 1.3.0
//
// Copy By RAY
// inthinkcolor@gmail.com
// 2013
//
// https://github.com/ushelp/EasyDataTable
//
var DataTable={cacheData:{},cacheDataRow:{},cacheThLength:{},cachePageTheme:{},cacheLanguage:{},cacheOrderArrow:{},SIMPLE_PAGE:"SIMPLE",FULL_PAGE:"FULL",lOADING_SHOW:false,lOADING_DEFALUT:{},LOADING_MSG:"数据正在读取中……",MSG:{first:"首页",previous:"上一页",next:"下一页",last:"末页",totalCount:"共{0}条",totalPage:"共{0}页",rowPerPage:"每页显示{0}条"},load:function(tableid,easydataParams){var nowDataTable=$("#"+tableid);nowDataTable.find("tr:gt(0)").css("visibility","hidden");easydataParams=easydataParams==undefined?{}:easydataParams;var dataForm=$("form").has("#"+tableid);if(!DataTable.cacheDataRow[tableid]){var dataRow=("<tr>"+nowDataTable.find(" tr:eq(1)").html()+"</tr>").replace(/\n/g,"").replace(/\r/g,"").replace("}%","}%\r\n");DataTable.cacheDataRow[tableid]=dataRow;nowDataTable.find(" tr:eq(1)").find("td").css("border","0");nowDataTable.find(" tr:eq(1)").css("border","0")}if(DataTable.lOADING_DEFALUT[tableid]==undefined){if(!(easydataParams.loading==undefined)){DataTable.lOADING_DEFALUT[tableid]=easydataParams.loading}else{DataTable.lOADING_DEFALUT[tableid]=DataTable.lOADING_SHOW}}if(easydataParams.language){DataTable.cacheLanguage[tableid]=easydataParams.language}if(DataTable.cacheLanguage[tableid]==undefined){DataTable.cacheLanguage[tableid]=DataTable.MSG}if(DataTable.lOADING_DEFALUT[tableid]==true){nowDataTable.find(" tr:gt(0)").remove();nowDataTable.after('<tr name="DataTable_Loading" ><td colspan=\''+$("#"+tableid+" tr:eq(0)").find("th").length+"'><div class='DataTable_Loading'>"+DataTable.LOADING_MSG+"</div></td></tr>")}if(!DataTable.cachePageTheme[tableid]){DataTable.cachePageTheme[tableid]=easydataParams.pagetheme}var pagenoEle=dataForm.find("[name='pageNo']");var rowperpageEle=dataForm.find("[name='rowPerPage']");if(!this.Validate.integer.test(pagenoEle.val())){pagenoEle.val(1)}postParam=dataForm.serialize();$.post(dataForm.attr("action"),postParam,function(data){if(typeof(data)=="string"){data=eval("("+data+")")}DataTable.cacheData[tableid]=data;var content="";var j=0;var valueObject=nowDataTable.attr("value");var dataTableOrder="";var dataTableSort="";if(valueObject){dataTableOrder=data[valueObject].order;dataTableSort=data[valueObject].sort;if(!dataTableOrder){dataTableOrder=data.order}if(!dataTableSort){dataTableSort=data.sort}if(!dataTableOrder){dataTableOrder=""}if(!dataTableSort){dataTableSort=""}for(var i in data[valueObject].data){data[valueObject].data[i].datatableCount=parseInt(j)+1;data[valueObject].data[i].datatableIndex=parseInt(j);for(var property in data){if(property!=valueObject){data[valueObject].data[i][property]=data[property]}}data[valueObject].data[i].pageNo=parseInt(data[valueObject].pageNo);data[valueObject].data[i].rowPerPage=parseInt(data[valueObject].rowPerPage);data[valueObject].data[i].totalCount=parseInt(data[valueObject].totalCount);data[valueObject].data[i].key=i;data[valueObject].data[i].order=dataTableOrder;data[valueObject].data[i].sort=dataTableSort;content+=DataTable.formatContent(DataTable.cacheDataRow[tableid],data[valueObject].data[i]);j++}}else{dataTableOrder=data.data.order;dataTableSort=data.data.sort;for(var i in data.data){for(var property in data){if(property!="data"){data.data[i][property]=data[property]}}data.data[i].datatableCount=parseInt(j)+1;data.data[i].datatableIndex=parseInt(j);data.data[i].key=i;data.data[i].order=dataTableOrder;data.data[i].sort=dataTableSort;content+=DataTable.formatContent(DataTable.cacheDataRow[tableid],data.data[i]);j++}}nowDataTable.find(" tr:gt(0)").remove();if(DataTable.lOADING_DEFALUT[tableid]==true){dataForm.find("[name='DataTable_Loading']").remove()}var orderInfo="<input type='hidden' name='order' value='"+dataTableOrder+"'/><input type='hidden' name='sort' value='"+dataTableSort+"'/>";content+=orderInfo;nowDataTable.append(content);nowDataTable.find(" tr:eq(1)").css("visibility","visible");nowDataTable.find(" tr:even").addClass("evenColor");nowDataTable.find(" tr").hover(function(){$(this).addClass("tdHover")},function(){$(this).removeClass("tdHover")});var oldTr;nowDataTable.find(" tr").on("click",function(){if(oldTr){oldTr.removeClass("tdClick")}$(this).addClass("tdClick");oldTr=$(this)});DataTable.pageTheme(tableid,DataTable.cachePageTheme[tableid]);dataForm.find(" .pages .totalCount").html(data.totalCount);dataForm.find(" .mycombox").val(data.rowPerPage);dataForm.find(" [name='pageNo']").val(data.pageNo);dataForm.find(" .pages .maxPage").html(Math.floor(((parseInt(data.totalCount)-1)/parseInt(data.rowPerPage))+1));dataForm.find("[name='rowPerPage']").off("change");dataForm.find("[name='rowPerPage']").on("change",function(e){DataTable.load(tableid)});DataTable.pageCheck(tableid)})},reload:function(b){var a=$("form").has("#"+b);a.find("[name='order']").val("");a.find("[name='sort']").val("");if(DataTable.cacheOrderArrow[b]){DataTable.cacheOrderArrow[b].html("&uarr;&darr;")}DataTable.load(b)},out:function(a){return a},formatContent:function(content,jsondata){var reg=/\{([^}]+)\}/g;var regExp=/\%\{(.*)\}\%/g;content=content.replace(regExp,function(m,i){with(jsondata){try{return eval($.trim(i))}catch(e){return m}}});content=content.replace(reg,function(m,i){with(jsondata){try{return eval($.trim(i))==null?"":eval($.trim(i))}catch(e){return""}}});return content},Validate:{integer:/^[1-9][0-9]*$/},first:function(c){var b=$("form").has("#"+c);var a=b.find("[name='pageNo']");a.val(1);this.load(c)},prev:function(c){var b=$("form").has("#"+c);var a=b.find("[name='pageNo']");a.val(parseInt(this.cacheData[c]["pageNo"])-1);this.load(c)},next:function(c){var b=$("form").has("#"+c);var a=b.find("[name='pageNo']");a.val(parseInt(this.cacheData[c]["pageNo"])+1);this.load(c)},last:function(c){var b=$("form").has("#"+c);var a=b.find("[name='pageNo']");a.val(Math.floor(((parseInt(this.cacheData[c]["totalCount"])-1)/parseInt(this.cacheData[c]["rowPerPage"]))+1));this.load(c)},gopage:function(c){var b=$("form").has("#"+c);var a=b.find("[name='pageNo']");if(this.cacheData[c]["pageNo"]!=b.find("[name='pageNo']").val()&&DataTable.Validate.integer.test(a.val())){this.load(c)}},numgoto:function(c,d){var b=$("form").has("#"+c);var a=b.find("[name='pageNo']");a.val($(d.target).text());if(this.cacheData[c]["pageNo"]!=b.find("[name='pageNo']").val()){this.load(c)}},pageCheck:function(a){var b=$("form").has("#"+a);var i=Math.floor(((parseInt(this.cacheData[a]["totalCount"])-1)/parseInt(this.cacheData[a]["rowPerPage"]))+1);var c=parseInt(this.cacheData[a]["pageNo"]);var g=b.find("[name='first']");var e=b.find("[name='prev']");var h=b.find("[name='next']");var j=b.find("[name='last']");var f=b.find("[name='pagegoto']");var d=b.find("[name='numgoto']");g.off("click");e.off("click");h.off("click");j.off("click");f.off("click");d.off("click");g.on("click",function(){DataTable.first(a)});e.on("click",function(){DataTable.prev(a)});h.on("click",function(){DataTable.next(a)});j.on("click",function(){DataTable.last(a)});f.on("click",function(){DataTable.gopage(a)});d.on("click",function(k){DataTable.numgoto(a,k)});g.unbind("mouseenter").unbind("mouseleave");e.unbind("mouseenter").unbind("mouseleave");h.unbind("mouseenter").unbind("mouseleave");j.unbind("mouseenter").unbind("mouseleave");DataTable.loadInit();g.removeClass("dispaggo");e.removeClass("dispaggo");h.removeClass("dispaggo");j.removeClass("dispaggo");if(c<=1){g.off("click");e.off("click");g.removeClass("pageGoHover");e.removeClass("pageGoHover");g.addClass("dispaggo");e.addClass("dispaggo");g.unbind("mouseenter").unbind("mouseleave");e.unbind("mouseenter").unbind("mouseleave")}if(c>=i){j.off("click");h.off("click");j.removeClass("pageGoHover");h.removeClass("pageGoHover");j.addClass("dispaggo");h.addClass("dispaggo");j.unbind("mouseenter").unbind("mouseleave");h.unbind("mouseenter").unbind("mouseleave")}},checkAll:function(c,a){var b=c.checked;if(b){$(c.form).find("[name='"+a+"']").each(function(){this.checked=true})}else{$(c.form).find("[name='"+a+"']").each(function(){this.checked=false})}},pageMsgCkeck:function(a){if(!DataTable.cacheLanguage[a].first){DataTable.cacheLanguage[a].first=DataTable.MSG.first}if(!DataTable.cacheLanguage[a].previous){DataTable.cacheLanguage[a].previous=DataTable.MSG.previous}if(!DataTable.cacheLanguage[a].next){DataTable.cacheLanguage[a].next=DataTable.MSG.next}if(!DataTable.cacheLanguage[a].last){DataTable.cacheLanguage[a].last=DataTable.MSG.last}if(!DataTable.cacheLanguage[a].totalPage){DataTable.cacheLanguage[a].totalPage=DataTable.MSG.totalPage}if(!DataTable.cacheLanguage[a].rowPerPage){DataTable.cacheLanguage[a].rowPerPage=DataTable.MSG.rowPerPage}if(!DataTable.cacheLanguage[a].totalCount){DataTable.cacheLanguage[a].totalCount=DataTable.MSG.totalCount}},pageTheme:function(g,y){var n=$("form").has("#"+g);var a=n.find(".panelBar").attr("size");var f=a.split(",");DataTable.pageMsgCkeck(g);var o=DataTable.cacheLanguage[g].rowPerPage.indexOf("{0}");var m=DataTable.cacheLanguage[g].rowPerPage.substring(0,o);var C=DataTable.cacheLanguage[g].rowPerPage.substring(o+3);var l='<div class="pages"><span>'+m+'</span><select class="mycombox" name="rowPerPage" >';$.each(f,function(E,D){l+='<option value="'+D+'" >'+D+"</option>"});l+="</select><span>"+C+"，";var z=DataTable.cacheLanguage[g].totalPage.indexOf("{0}");var v=DataTable.cacheLanguage[g].totalPage.substring(0,z);var k=DataTable.cacheLanguage[g].totalPage.substring(z+3);var B=DataTable.cacheLanguage[g].totalCount.indexOf("{0}");var x=DataTable.cacheLanguage[g].totalCount.substring(0,B);var t=DataTable.cacheLanguage[g].totalCount.substring(B+3);l+=x+'<label class="totalCount"></label>'+t+"</span></div>";var e='<div class="pages " style="float: right;text-align: right;">';var b='<span class="totalPage">'+v+'<label class="maxPage"></label>'+k+"</span>";var p='<span class="pagego" name="first">'+DataTable.cacheLanguage[g].first+'</span><span class="pagego" name="prev">'+DataTable.cacheLanguage[g].previous+"</span>";var j=0;var A=parseInt(this.cacheData[g]["pageNo"]);var u=Math.floor(((parseInt(this.cacheData[g]["totalCount"])-1)/parseInt(this.cacheData[g]["rowPerPage"]))+1);var j=A-3;var q=A+3;if(j<1){j=1;q=j+6;if(q>u){q=u}}if(q>u){q=u;j=q-6;if(j<1){j=1}}var w="";for(var s=j;s<=q;s++){if(s==A){w+='<span class="pagego nowpagenum" name="numgoto">'+s+"</span>"}else{w+='<span class="pagego" name="numgoto">'+s+"</span>"}}var h='<span class="pagego" name="next">'+DataTable.cacheLanguage[g].next+'</span><span class="pagego" name="last">'+DataTable.cacheLanguage[g].last+"</span>";var c='<span class="pagego"><input type="text" class="gototxt" name="pageNo"  /></span>';c+='<span class="pagegoto" name="pagegoto">&gt;&gt;</span>';var d="</div>";var r;if((!y)||y=="FULL"){r=l+e+b+p+w+h+c+d}else{if(y=="SIMPLE"){r=l+e+b+p+h+c+d}}n.find(".panelBar").html(r)},loadInit:function(){$(".pagego").hover(function(){$(this).addClass("pageGoHover")},function(){$(this).removeClass("pageGoHover")})},init:function(){$(".pagego").hover(function(){$(this).addClass("pageGoHover")},function(){$(this).removeClass("pageGoHover")});$(".datatable").find("tr:eq(1)").css("visibility","hidden");$("[class~='easydatatable']").each(function(){var a=$(this).attr("id");if(a){DataTable.load(a)}});$("[class~='easydatatable_search']").each(function(){var a=$(this.form).find("table[id]").attr("id");var b=$(this);b.off("click");b.on("click",function(){if(a){DataTable.load(a)}})});$("table:has([order])").each(function(){var b=$(this);var a=b.attr("id");b.find("[order]").each(function(){var d=$(this);d.html(d.html()+"<span class='sortArrow' name='orderspan'>&uarr;&darr;</span>");d.css("cursor","pointer");d.off("click");var c=$("form").has("#"+a);d.on("click",function(h){var f=d.attr("order");c.find("input[name='order']").val(f);c.find("input[name='sort']").val(c.find("input[name='sort']").val().toLowerCase()=="asc"?"desc":"asc");var g=$(this).find("[name='orderspan']");if(DataTable.cacheOrderArrow[a]){DataTable.cacheOrderArrow[a].html("&uarr;&darr;")}if(c.find("input[name='sort']").val()=="asc"){g.html("&uarr;")}else{if(c.find("input[name='sort']").val()=="desc"){g.html("&darr;")}else{g.html("&uarr;&darr;")}}DataTable.cacheOrderArrow[a]=g;DataTable.load(a)})});b.find("[order]").hover(function(){var c=$(this).find("[name='orderspan']");c.removeClass("sortArrow");c.removeClass("sortArrowDown");c.addClass("sortArrowHover")},function(){var c=$(this).find("[name='orderspan']");c.removeClass("sortArrowHover");c.addClass("sortArrow")});b.find("[order]").on("mousedown",function(){var c=$(this).find("[name='orderspan']");c.removeClass("sortArrowHover");c.addClass("sortArrowDown")});b.find("[order]").on("mouseup",function(){var c=$(this).find("[name='orderspan']");c.removeClass("sortArrowDown");c.addClass("sortArrowHover")})})}};$(function(){DataTable.init()});
